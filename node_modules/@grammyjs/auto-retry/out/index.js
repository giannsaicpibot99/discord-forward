"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.autoRetry = void 0;
function pause(seconds) {
    return new Promise(resolve => setTimeout(resolve, 1000 * seconds));
}
/**
 * Creates an [API transformer
 * function](https://grammy.dev/advanced/transformers.html) that will check
 * failed API requests for a `retry_after` value, and attempt to perform them
 * again after waiting the specified number of seconds.
 *
 * You can set an option to only retry requests a number of times, or only retry
 * those that to not demand your bot to wait too long.
 *
 * @param options Configuration options
 * @returns The created API transformer function
 */
function autoRetry(options) {
    var _a, _b, _c;
    const maxDelay = (_a = options === null || options === void 0 ? void 0 : options.maxDelaySeconds) !== null && _a !== void 0 ? _a : 3600;
    const maxRetries = (_b = options === null || options === void 0 ? void 0 : options.maxRetryAttempts) !== null && _b !== void 0 ? _b : 3;
    const retryOnInternalServerErrors = (_c = options === null || options === void 0 ? void 0 : options.retryOnInternalServerErrors) !== null && _c !== void 0 ? _c : false;
    return async (prev, method, payload, signal) => {
        var _a;
        let remainingAttempts = maxRetries;
        let result = await prev(method, payload, signal);
        while (!result.ok && remainingAttempts-- > 0) {
            let retry = false;
            if (typeof ((_a = result.parameters) === null || _a === void 0 ? void 0 : _a.retry_after) === 'number' &&
                result.parameters.retry_after <= maxDelay) {
                await pause(result.parameters.retry_after);
                retry = true;
            }
            else if (result.error_code >= 500 &&
                retryOnInternalServerErrors) {
                retry = true;
            }
            if (!retry)
                return result;
            else
                result = await prev(method, payload, signal);
        }
        return result;
    };
}
exports.autoRetry = autoRetry;
